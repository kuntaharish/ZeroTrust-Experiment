#!/usr/bin/env bash
set -euo pipefail

# Usage:
#   bash scripts/gen_certs.sh
#   KEY_TYPE=ecdsa bash scripts/gen_certs.sh
#   KEY_TYPE=rsa RSA_BITS=4096 bash scripts/gen_certs.sh
#
# KEY_TYPE: rsa | ecdsa (default rsa)
# RSA_BITS: 2048 | 3072 | 4096 (default 2048)
# ECDSA_CURVE: prime256v1 | secp384r1 (default prime256v1)

KEY_TYPE="${KEY_TYPE:-rsa}"
RSA_BITS="${RSA_BITS:-2048}"
ECDSA_CURVE="${ECDSA_CURVE:-prime256v1}"

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
CERT_DIR="${ROOT_DIR}/certs"
mkdir -p "${CERT_DIR}"
cd "${CERT_DIR}"

gen_rsa_key() {
  local out="$1"
  openssl genrsa -out "${out}" "${RSA_BITS}" >/dev/null 2>&1
}

gen_ecdsa_key() {
  local out="$1"
  openssl ecparam -name "${ECDSA_CURVE}" -genkey -noout -out "${out}" >/dev/null 2>&1
}

gen_key() {
  local out="$1"
  if [[ "${KEY_TYPE}" == "rsa" ]]; then
    gen_rsa_key "${out}"
  elif [[ "${KEY_TYPE}" == "ecdsa" ]]; then
    gen_ecdsa_key "${out}"
  else
    echo "âŒ Unknown KEY_TYPE=${KEY_TYPE}. Use rsa or ecdsa."
    exit 1
  fi
}

write_metadata() {
  local now
  now="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
  cat > cert_metadata.json <<EOF
{
  "generated_utc": "${now}",
  "key_type": "${KEY_TYPE}",
  "rsa_bits": "${RSA_BITS}",
  "ecdsa_curve": "${ECDSA_CURVE}",
  "notes": "This file is generated by scripts/gen_certs.sh for reproducibility."
}
EOF
}

echo "ðŸ” Generating trusted CA (${KEY_TYPE})..."
gen_key "ca.key"
openssl req -x509 -new -nodes -key ca.key -sha256 -days 3650 \
  -subj "/CN=ZT-Trusted-CA" \
  -out ca.crt >/dev/null 2>&1

echo "ðŸ” Generating server cert for localhost (SAN=localhost)..."
gen_key "server.key"

cat > server_openssl.cnf <<'EOF'
[ req ]
prompt             = no
default_md         = sha256
distinguished_name = dn
req_extensions     = req_ext

[ dn ]
CN = localhost

[ req_ext ]
subjectAltName = @alt_names

[ alt_names ]
DNS.1 = localhost
IP.1  = 127.0.0.1
EOF

openssl req -new -key server.key -out server.csr -config server_openssl.cnf >/dev/null 2>&1
openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial \
  -out server.crt -days 825 -sha256 -extensions req_ext -extfile server_openssl.cnf >/dev/null 2>&1

gen_client () {
  local name="$1"
  echo "ðŸ” Generating client cert for ${name}..."
  gen_key "${name}.key"
  openssl req -new -key "${name}.key" -out "${name}.csr" -subj "/CN=${name}" >/dev/null 2>&1
  openssl x509 -req -in "${name}.csr" -CA ca.crt -CAkey ca.key -CAcreateserial \
    -out "${name}.crt" -days 825 -sha256 >/dev/null 2>&1
}

gen_client "service-a"
gen_client "service-b"
gen_client "service-c"
gen_client "service-d"

echo "ðŸ§ª Generating rogue CA + rogue client cert (RSA-2048 for attacker realism)..."
openssl genrsa -out rogue_ca.key 2048 >/dev/null 2>&1
openssl req -x509 -new -nodes -key rogue_ca.key -sha256 -days 3650 \
  -subj "/CN=Rogue-CA" \
  -out rogue_ca.crt >/dev/null 2>&1

openssl genrsa -out rogue_client.key 2048 >/dev/null 2>&1
openssl req -new -key rogue_client.key -out rogue_client.csr -subj "/CN=evil-worm" >/dev/null 2>&1
openssl x509 -req -in rogue_client.csr -CA rogue_ca.crt -CAkey rogue_ca.key -CAcreateserial \
  -out rogue_client.crt -days 825 -sha256 >/dev/null 2>&1

chmod 600 *.key || true

write_metadata

echo "âœ… Done. Generated certs in ${CERT_DIR}"
echo "   Metadata: cert_metadata.json"
echo "   Trusted CA: ca.crt"
echo "   Server: server.crt/server.key"
echo "   Clients: service-a..service-d (.crt/.key)"
echo "   Rogue: rogue_client.crt signed by rogue_ca.crt"
