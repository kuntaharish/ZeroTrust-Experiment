upstream svc_a { server svc_a:5000; keepalive 64; }
upstream svc_b { server svc_b:5000; keepalive 64; }
upstream svc_c { server svc_c:5000; keepalive 64; }
upstream svc_d { server svc_d:5000; keepalive 64; }

# Extract CN from client DN
map $ssl_client_s_dn $client_cn {
    default "unknown";
    ~CN=([^,]+) $1;
}

# Inbound allowlists (micro-segmentation policy)
# Cluster1: a<->b, Cluster2: c<->d

map $client_cn $allow_to_a {
    default 0;
    "service-a" 1;
    "service-b" 1;
}

map $client_cn $allow_to_b {
    default 0;
    "service-a" 1;
    "service-b" 1;
}

map $client_cn $allow_to_c {
    default 0;
    "service-c" 1;
    "service-d" 1;
}

map $client_cn $allow_to_d {
    default 0;
    "service-c" 1;
    "service-d" 1;
}

server {
    listen 443 ssl;
    server_name localhost;

    ssl_certificate     /certs/server.crt;
    ssl_certificate_key /certs/server.key;
    ssl_protocols TLSv1.2 TLSv1.3;

    # Require client cert (mTLS)
    ssl_client_certificate /certs/ca.crt;
    ssl_verify_client on;
    ssl_verify_depth 2;

    keepalive_timeout 65;
    keepalive_requests 10000;

    ssl_session_cache   shared:SSL:50m;
    ssl_session_timeout 1h;
    ssl_session_tickets on;

    # service-a
    location /a/ {
        if ($allow_to_a = 0) { return 403; }
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header X-Client-CN $client_cn;
        proxy_set_header X-Client-DN $ssl_client_s_dn;
        proxy_pass http://svc_a/;
    }

    # service-b
    location /b/ {
        if ($allow_to_b = 0) { return 403; }
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header X-Client-CN $client_cn;
        proxy_set_header X-Client-DN $ssl_client_s_dn;
        proxy_pass http://svc_b/;
    }

    # service-c
    location /c/ {
        if ($allow_to_c = 0) { return 403; }
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header X-Client-CN $client_cn;
        proxy_set_header X-Client-DN $ssl_client_s_dn;
        proxy_pass http://svc_c/;
    }

    # service-d
    location /d/ {
        if ($allow_to_d = 0) { return 403; }
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        proxy_set_header X-Client-CN $client_cn;
        proxy_set_header X-Client-DN $ssl_client_s_dn;
        proxy_pass http://svc_d/;
    }
}
